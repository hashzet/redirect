<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Profiles</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .sidebar {
            background: linear-gradient(180deg, #454B1B 0%, #383d15 100%);
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto; /* Enable vertical scrolling */
            max-height: 100vh; /* Limit height to viewport height */
        }

        .profile-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .profile-card:hover {
            transform: translateY(-2px);
        }

        .nav-button {
            transition: all 0.2s;
        }

        .nav-button:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .sidebar-link {
            transition: all 0.2s;
            padding: 0.3rem 1rem;
            border-radius: 8px;
            margin-bottom: 0.1rem;
        }

        .sidebar-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .active-link {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .qualification-item {
            border-left: 3px solid #454B1B;
            padding-left: 1rem;
            margin-bottom: 1rem;
        }

        .evaluation-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e2e8f0;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
        }

        .evaluation-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #454B1B;
            cursor: pointer;
            transition: all 0.2s;
        }

        .evaluation-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .checkbox-wrapper {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 8px;
        }

        .save-button {
            transition: all 0.2s;
            opacity: 0.5;
            cursor: not-allowed;
            background: #454B1B;
        }

        .save-button.active {
            opacity: 1;
            cursor: pointer;
            background: #454B1B;
        }

        .save-button.active:hover {
            transform: scale(1.05);
            background: #454B1B;
        }
        .examiner-select {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem;
            border-radius: 8px;
            width: 100%;
            margin-bottom: 1rem;
            cursor: pointer;
        }

        .examiner-select option {
            background-color: #454B1B;
            color: white;
        }

        .examiner-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .clear-examiner {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            display: none;
        }

        .clear-examiner.visible {
            display: block;
        }

        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
        }

        .profile-header img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-right: 1.5rem;
            object-fit: cover;
        }

        .profile-header h2 {
            font-size: 1.75rem;
            font-weight: 600;
            color: #333;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="flex">
        <div class="sidebar w-72 min-h-screen p-6 text-white fixed">
            <div class="flex flex-col items-center mb-8">
                <div class="w-24 h-24 bg-white rounded-full mb-4 overflow-hidden">
                    <img src="https://i.ibb.co/mWJsy8N/Untitled-design-7.png" alt="Inf Dir" class="w-full h-full object-cover">
                </div>
                <h1 id="groupTitle" class="text-xl font-semibold text-center">LEMBAGA PENCALONAN KPSM/TLN 2026</h1>
            </div>
            <div class="examiner-container mb-6">
                <select id="examinerSelect" class="examiner-select">
                    <option value="">Pilih Ahli Panel</option>
                    <option value="Pengarah Inf">Pengarah Inf</option>
                    <option value="Timb Pengarah Inf">Timb Pengarah Inf</option>
                    <option value="PS 1 A">PS 1 A</option>
                    <option value="PS 2 A RAMD">PS 2 A RAMD</option>
                    <option value="PS 2 A RRD">PS 2 A RRD</option>
                    <option value="PS 2 Kerjaya RS">PS 2 Kerjaya RS</option>
                </select>
                <span id="clearExaminer" class="clear-examiner" title="Clear selection">&times;</span>
            </div>
            <nav>
                <ul id="groupList" class="space-y-2">
                    <!-- Groups will be added here -->
                </ul>
            </nav>
        </div>

        <main class="flex-1 ml-72 p-8">
            <div id="profilesContainer" class="max-w-4xl mx-auto">
                <!-- Profiles will be added here -->
            </div>

            <div class="flex justify-center gap-4 mt-8">
                <button id="prevBtn" class="nav-button bg-green-600 text-white px-6 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    Previous
                </button>
                <button id="nextBtn" class="nav-button bg-green-600 text-white px-6 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    Next
                </button>
            </div>
        </main>
    </div>

    <script>
        let selectedExaminer = '';
        const examinerSelect = document.getElementById('examinerSelect');
        const clearExaminer = document.getElementById('clearExaminer');

        function initializeExaminerSelection() {
            const savedExaminer = sessionStorage.getItem('selectedExaminer');
            if (savedExaminer) {
                examinerSelect.value = savedExaminer;
                selectedExaminer = savedExaminer;
                clearExaminer.classList.add('visible');
                examinerSelect.disabled = true;
            }

            examinerSelect.addEventListener('change', function() {
                selectedExaminer = this.value;
                if (selectedExaminer) {
                    sessionStorage.setItem('selectedExaminer', selectedExaminer);
                    clearExaminer.classList.add('visible');
                    this.disabled = true;
                }
            });

            clearExaminer.addEventListener('click', function() {
                sessionStorage.removeItem('selectedExaminer');
                examinerSelect.value = '';
                selectedExaminer = '';
                clearExaminer.classList.remove('visible');
                examinerSelect.disabled = false;
            });
        }

        const profilesContainer = document.getElementById('profilesContainer');
        const groupList = document.getElementById('groupList');
        const groupTitle = document.getElementById('groupTitle');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        let profiles = [];
        let currentIndex = 0;
        let currentGroup = '';

        async function fetchData() {
            const response = await fetch('https://script.google.com/macros/s/AKfycby1-ScNCS3MQyoOTfvAYLqzjJ0qAIB6f2P1P-RUDfEZ4YhbYqzcRjRjSQQucr140_ts/exec');
            const data = await response.json();
            profiles = data;
            displayGroups(data);
            displayProfile(0);
        }

        function displayGroups(data) {
            const groups = [...new Set(data.map(item => item.NO_KUMP))];
            groupList.innerHTML = groups.map(group =>
                `<li>
                    <a href="#" class="sidebar-link block text-sm font-medium" data-group="${group}">
                        ${group}
                    </a>
                </li>`
            ).join('');

            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', event => {
                    event.preventDefault();
                    document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active-link'));
                    link.classList.add('active-link');
                    const group = event.target.getAttribute('data-group');
                    currentGroup = group;
                    currentIndex = profiles.findIndex(profile => profile.NO_KUMP === group);
                    groupTitle.textContent = `LEMBAGA PENCALONAN KPSM/TLN 2026 ${group}`;
                    displayProfile(currentIndex);
                });
            });
        }

        function formatQualification(profile, mainField, kedField, gredField) {
            const mainValue = profile[mainField] || '-';
            const kedValue = profile[kedField] ? ` (${profile[kedField]})` : '';
            const gredValue = profile[gredField] ? ` | Gred: ${profile[gredField]}` : '';
            return `${mainValue}${kedValue}${gredValue}`;
        }

        function displayProfile(index) {
            const profile = profiles[index];
            const sections = [
                {
                    title: 'Jawatan & Pasukan',
                    fields: ['JAWATAN_SEKARANG', 'PASUKAN', 'TAHUN_DI_PSK']
                },
                {
                    title: 'Maklumat Perkhidmatan',
                    fields: ['MULA_KHIDMAT', 'TARIKH_TAULIAH', 'TAHUN_KHIDMAT']
                },
                {
                    title: 'Maklumat Peribadi',
                    fields: ['DOB', 'UMUR', 'TEMPAT_LAHIR', 'STATUS', 'AKADEMIK']
                }
            ];

            const qualificationsSection = {
                title: 'Kursus & Pencapaian',
                groups: [
                    {
                        title: '',
                        fields: ['MERIT']
                    },
                    {
                        title: 'G2',
                        value: 'Siri ' + formatQualification(profile, 'SIRI_G2', 'KED_G2', 'GRED_G2')
                    },
                    {
                        title: 'G3',
                        value: formatQualification(profile, 'SIRI_G3', 'KED_G3', 'GRED_G3')
                    },
                    {
                        title: 'Ketua Kompeni',
                        value: formatQualification(profile, 'SIRI_KK', 'KED_KK', 'GRED_KK')
                    },
                    {
                        title: 'Kursus Lain',
                        fields: ['KURSUS_BAHASA', 'KURSUS_UN', 'PENGLIBATAN_LUAR_NEGARA']
                    },
                    {
                        title: 'Ujian ADFELPS',
                        fields: ['SPEAKING', 'LISTENING', 'READING', 'WRITING']
                    }
                ]
            };

            const sectionsHTML = sections.map(section => `
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">${section.title}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${section.fields.map(field => `
                            <div class="flex flex-col">
                                <span class="text-sm text-gray-500">${field.replace(/_/g, ' ')}</span>
                                <span class="font-medium">${profile[field] || '-'}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            const qualificationsHTML = `
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">${qualificationsSection.title}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${qualificationsSection.groups.map(group => {
                            if (group.fields) {
                                return `
                                    <div class="qualification-item">
                                        <h4 class="font-medium text-green-800 mb-2">${group.title}</h4>
                                        ${group.fields.map(field => `
                                            <div class="mb-2">
                                                <span class="text-sm text-gray-500">${field.replace(/_/g, ' ')}</span>
                                                <span class="block font-medium">${profile[field] || '-'}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                `;
                            } else {
                                return `
                                    <div class="qualification-item">
                                        <h4 class="font-medium text-green-800 mb-2">${group.title}</h4>
                                        <span class="block font-medium">${group.value}</span>
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>
                </div>
            `;

            const evaluationHTML = `
        <div class="mb-8 mt-8 border-t pt-8">
            <h3 class="text-lg font-semibold mb-6 text-gray-700">Performance Evaluation</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Speech (75%)
                        </label>
                        <input type="range"
                               class="evaluation-slider"
                               id="speech-slider"
                               min="0"
                               max="100"
                               value="75"
                               oninput="updateSliderValue(this, 'speech-value')">
                        <span id="speech-value" class="text-sm text-gray-500">75%</span>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Appearance (75%)
                        </label>
                        <input type="range"
                               class="evaluation-slider"
                               id="appearance-slider"
                               min="0"
                               max="100"
                               value="75"
                               oninput="updateSliderValue(this, 'appearance-value')">
                        <span id="appearance-value" class="text-sm text-gray-500">75%</span>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Idea (75%)
                        </label>
                        <input type="range"
                               class="evaluation-slider"
                               id="idea-slider"
                               min="0"
                               max="100"
                               value="75"
                               oninput="updateSliderValue(this, 'idea-value')">
                        <span id="idea-value" class="text-sm text-gray-500">75%</span>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Confidence (75%)
                        </label>
                        <input type="range"
                               class="evaluation-slider"
                               id="confidence-slider"
                               min="0"
                               max="100"
                               value="75"
                               oninput="updateSliderValue(this, 'confidence-value')">
                        <span id="confidence-value" class="text-sm text-gray-500">75%</span>
                    </div>
                </div>
            </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Comments</label>
                        <textarea id="evaluation-comments"
                                  class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                  rows="4"
                                  placeholder="Enter your comments here..."
                                  oninput="checkFormValidity()"></textarea>
                    </div>

                    <div class="flex flex-wrap gap-6 mb-6">
                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="tln-checkbox" onchange="checkFormValidity()">
                            <span class="text-sm font-medium text-gray-700">TLN</span>
                        </label>

                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="local-checkbox" onchange="checkFormValidity()">
                            <span class="text-sm font-medium text-gray-700">Local</span>
                        </label>

                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="fail-checkbox" onchange="checkFormValidity()">
                            <span class="text-sm font-medium text-gray-700">Gagal</span>
                        </label>
                    </div>

                    <button id="save-evaluation"
                            onclick="saveEvaluation()"
                            class="save-button bg-green-600 text-white px-6 py-2 rounded-lg w-full md:w-auto"
                            disabled>
                        Save Evaluation
                    </button>
                </div>
            `;

            profilesContainer.innerHTML = `
                <div class="profile-card p-8">
                    <div class="profile-header">
                        <img src="${profile.ImageURL}" alt="${profile.NAMA_PENUH}">
                        <h1>${profile.NAMA_PENUH}</h1>
                    </div>
                    ${sectionsHTML}
                    ${qualificationsHTML}
                    ${evaluationHTML}
                </div>
            `;

            prevBtn.disabled = currentIndex === 0;
            nextBtn.disabled = currentIndex === profiles.length - 1;
        }

        function updateSliderValue(slider, valueId) {
            const value = slider.value;
            document.getElementById(valueId).textContent = value + '%';
            checkFormValidity();
        }

        function checkFormValidity() {
            const sliders = ['speech-slider', 'appearance-slider', 'idea-slider', 'confidence-slider'];
            const comments = document.getElementById('evaluation-comments').value.trim();
            const saveButton = document.getElementById('save-evaluation');

            const slidersChanged = sliders.some(id => document.getElementById(id).value > 0);

            if ((slidersChanged || comments.length > 0) && selectedExaminer) {
                saveButton.disabled = false;
                saveButton.classList.add('active');
            } else {
                saveButton.disabled = true;
                saveButton.classList.remove('active');
            }
        }

        async function saveEvaluation() {
    if (!selectedExaminer) {
        alert('Please select an examiner profile before saving evaluation.');
        return;
    }

    const currentProfile = profiles[currentIndex];
    const evaluationData = {
        examiner: selectedExaminer,
        name: currentProfile.NAMA,
        speech: document.getElementById('speech-slider').value,
        appearance: document.getElementById('appearance-slider').value,
        idea: document.getElementById('idea-slider').value,
        confidence: document.getElementById('confidence-slider').value,
        comments: document.getElementById('evaluation-comments').value,
        tln: document.getElementById('tln-checkbox').checked,
        local: document.getElementById('local-checkbox').checked,
        fail: document.getElementById('fail-checkbox').checked,
        timestamp: new Date().toISOString()
    };

    try {
        const response = await fetch('https://script.google.com/macros/s/AKfycbwQztcAfRwRADBZqV3AKszHZs45H1OC6S5rzoavK8B86mYORECB93wZu084kN2eskaA/exec', {
            method: 'POST',
            body: JSON.stringify(evaluationData)
        });

        if (response.ok) {
            alert('Evaluation saved successfully!');
            if (currentIndex < profiles.length - 1) {
                currentIndex++;
                displayProfile(currentIndex);
            }
            resetEvaluationForm();
        } else {
            throw new Error('Failed to save evaluation');
        }
    } catch (error) {
        alert('Error saving evaluation: ' + error.message);
    }
    }

    function resetEvaluationForm() {
    const sliders = ['speech-slider', 'appearance-slider', 'idea-slider', 'confidence-slider'];
    sliders.forEach(id => {
        const slider = document.getElementById(id);
        slider.value = 75;
        document.getElementById(id.replace('-slider', '-value')).textContent = '75%';
    });

    document.getElementById('evaluation-comments').value = '';
    document.getElementById('tln-checkbox').checked = false;
    document.getElementById('local-checkbox').checked = false;
    document.getElementById('fail-checkbox').checked = false;

    checkFormValidity();
    }

        prevBtn.addEventListener('click', () => {
            if (currentIndex > 0) {
                currentIndex--;
                displayProfile(currentIndex);
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentIndex < profiles.length - 1) {
                currentIndex++;
                displayProfile(currentIndex);
            }
        });

        fetchData().then(() => {
            initializeExaminerSelection();
        });
    </script>
</body>
</html>
